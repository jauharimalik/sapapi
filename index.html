<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coldspace Data Overview</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Roboto', sans-serif;
        }
        .container-main {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 0 15px;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .search-export-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
            min-width: 300px;
        }
        .tabs-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            margin-bottom: 20px;
            scrollbar-width: none;
        }
        .tabs-container::-webkit-scrollbar {
            display: none;
        }
        .tab-item {
            padding: 12px 24px;
            background: #e0e0e0;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            cursor: pointer;
            font-weight: 500;
            color: #555;
            transition: all 0.3s;
        }
        .tab-item.active {
            background: #6c7ae0;
            color: white;
        }
        .table-container {
            max-height: 70vh;
            overflow: auto;
            position: relative;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: white;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            white-space: nowrap;
        }
        th {
            position: sticky;
            top: 0;
            background-color: #6c7ae0;
            color: white;
            z-index: 10;
            cursor: pointer;
            padding: 15px 10px;
            text-align: left;
            font-weight: 500;
        }
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
        }
        tr:hover {
            background-color: #f8f9ff;
        }
        .sticky-col {
            position: sticky;
            left: 0;
            background-color: #ffffff;
            z-index: 9;
            box-shadow: 2px 0 3px -1px rgba(0,0,0,0.1);
        }
        th.sticky-col {
            z-index: 11;
            background-color: #6c7ae0;
        }
        .sort-icon {
            font-size: 1.2em;
            vertical-align: middle;
            margin-left: 5px;
        }
        .dropdown-trigger {
            padding: 0 8px;
            height: 30px;
            line-height: 30px;
        }
        .dropdown-content {
            min-width: 120px;
        }
        .dropdown-content li a {
            color: #333;
            font-size: 14px;
            padding: 8px 16px;
        }
        .dropdown-content li a:hover {
            background-color: #f5f5f5;
        }
        .skeleton-row {
            height: 48px;
            border-bottom: 1px solid #eee;
        }
        .skeleton-row td {
            padding: 12px 10px;
        }
        .skeleton-row .skeleton-cell {
            background-color: #e0e0e0;
            height: 100%;
            border-radius: 4px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        .skeleton-row .skeleton-cell.wide {
            width: 80%;
        }
        .search-container {
            position: relative;
            flex-grow: 1;
            min-width: 200px;
        }
        .search-container .material-icons {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #999;
        }
        .search-container input {
            padding-left: 35px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-shadow: none;
            width: 100%;
        }
        .btn-export {
            background-color: #5cb85c;
            white-space: nowrap;
        }
        .btn-export:hover {
            background-color: #4cae4c;
        }
        .btn-action {
            background-color: #6c7ae0;
            color: white;
        }
        .btn-action:hover {
            background-color: #5a68d1;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        @keyframes pulse {
            0% { background-color: #e0e0e0; }
            50% { background-color: #f0f0f0; }
            100% { background-color: #e0e0e0; }
        }
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                align-items: stretch;
            }
            .search-export-container {
                flex-direction: column;
                gap: 10px;
            }
            .search-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="container container-main">
        <h4 class="center-align blue-text text-darken-2" style="padding-top: 20px;">Coldspace Data Overview</h4>

        <div class="tabs-container">
            <div class="tab-item active" onclick="switchTab('dn')">Delivery Note</div>
            <div class="tab-item" onclick="switchTab('gr')">Goods Receipt</div>
        </div>

        <div class="header-container">
            <div class="search-export-container">
                <div class="search-container">
                    <i class="material-icons">search</i>
                    <input type="text" id="searchInput" placeholder="Search data..." oninput="handleSearch()">
                </div>
                <button id="exportButton" class="btn btn-export waves-effect waves-light" onclick="exportToExcel()">
                    Export to Excel
                    <i class="material-icons right">file_download</i>
                </button>
            </div>
        </div>

        <div class="table-container" id="tableContainer" tabindex="0" onkeydown="handleTableKeydown(event)">
            <table class="geserkk">
                <thead id="tableHeader">
                    <!-- Headers will be populated by JavaScript -->
                </thead>
                <tbody id="tableBody">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="recheckModal" class="modal">
        <div class="modal-content">
            <h4>Recheck Details</h4>
            <div id="recheckModalContent">
                <div class="progress">
                    <div class="indeterminate"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        let allData = { dn: [], gr: [] };
        let displayedData = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        let currentTab = 'dn';
        let modalInstance = null;
        
        const API_BASE_URL = 'http://192.168.60.19:3300/api/';
        const DN_ENDPOINT = API_BASE_URL + 'tarikandn';
        const GR_ENDPOINT = API_BASE_URL + 'tarikangr';
        const RECHECK_ENDPOINT = API_BASE_URL + 'check-do?docnum=';

        const dnHeaders = [
            { key: 'id', label: 'ID' },
            { key: 'COMP_CODE', label: 'Comp Code' },
            { key: 'DO_NO', label: 'DO No' },
            { key: 'STO_NO', label: 'STO No' },
            { key: 'PL_NP', label: 'PL NP' },
            { key: 'DEL_DATE', label: 'Del Date' },
            { key: 'SITE', label: 'Site' },
            { key: 'SLOC', label: 'Sloc' },
            { key: 'LineNum', label: 'LineNum' },
            { key: 'SKU', label: 'SKU' },
            { key: 'QTY', label: 'QTY' },
            { key: 'LOT', label: 'LOT' },
            { key: 'QTY_KG', label: 'QTY KG' },
            { key: 'expired_date', label: 'Expired Date' },
            { key: 'ReasonFlag', label: 'Reason Flag' },
            { key: 'SU', label: 'SU' },
            { key: 'MED_TYPE', label: 'Med Type' },
            { key: 'ORDER_TYPE', label: 'Order Type' },
            { key: 'ismatch', label: 'Is Match' },
            { key: 'total_sku_do', label: 'Total SKU DO' },
            { key: 'total_sku_dn', label: 'Total SKU DN' },
            { key: 'jo_status', label: 'JO Status' },
            { key: 'doc_num', label: 'Doc Num' },
            { key: 'doc_entry', label: 'Doc Entry' },
            { key: 'note', label: 'Note' },
            { key: 'iswa', label: 'ISWA' },
            { key: 'created_at', label: 'Created At' },
            { key: 'updated_at', label: 'Updated At' }
        ];

        const grHeaders = [
            { key: 'id', label: 'ID' },
            { key: 'name_file', label: 'File Name' },
            { key: 'COMP_CODE', label: 'Comp Code' },
            { key: 'PO_NO', label: 'PO No' },
            { key: 'WMS_ASN_NO', label: 'WMS ASN No' },
            { key: 'PO_DATE', label: 'PO Date' },
            { key: 'PO_DEL', label: 'PO Del' },
            { key: 'RR_DATE', label: 'RR Date' },
            { key: 'VENDOR', label: 'Vendor' },
            { key: 'VENDORNAME', label: 'Vendor Name' },
            { key: 'LINE_NO', label: 'Line No' },
            { key: 'SKU', label: 'SKU' },
            { key: 'FLAG', label: 'Flag' },
            { key: 'QTYPO', label: 'QTY PO' },
            { key: 'QTYGR', label: 'QTY GR' },
            { key: 'SLOC', label: 'Sloc' },
            { key: 'VFDAT', label: 'VF Date' },
            { key: 'QTYPO_KG', label: 'QTY PO KG' },
            { key: 'QTYGR_KG', label: 'QTY GR KG' },
            { key: 'CODE_MAT', label: 'Code Mat' },
            { key: 'Surat_Jalan', label: 'Surat Jalan' },
            { key: 'nopolisi', label: 'No Polisi' },
            { key: 'driver', label: 'Driver' },
            { key: 'TRK_TYPE', label: 'TRK Type' },
            { key: 'SKU_QUALITY', label: 'SKU Quality' },
            { key: 'ismatch', label: 'Is Match' },
            { key: 'sku_from_count', label: 'SKU From Count' },
            { key: 'sku_gr_count', label: 'SKU GR Count' },
            { key: 'Whscode', label: 'Whs Code' },
            { key: 'batchnum_suggest', label: 'Batch Num Suggest' },
            { key: 'jo_status', label: 'JO Status' },
            { key: 'doc_num', label: 'Doc Num' },
            { key: 'doc_entry', label: 'Doc Entry' },
            { key: 'note', label: 'Note' },
            { key: 'note_gilang', label: 'Note Gilang' },
            { key: 'iswa', label: 'ISWA' },
            { key: 'jo_wh', label: 'JO WH' },
            { key: 'created_at', label: 'Created At' },
            { key: 'updated_at', label: 'Updated At' }
        ];

        window.onload = () => {
            modalInstance = M.Modal.init(document.getElementById('recheckModal'));
            fetchData('dn');
        };

        let switchTab = (tab) => {
            currentTab = tab;
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.tab-item:nth-child(${tab === 'dn' ? 1 : 2})`).classList.add('active');
            fetchData(tab);
        };

        let showSkeleton = () => {
            let skeletonHtml = '';
            let columnsCount = currentTab === 'dn' ? dnHeaders.length + 1 : grHeaders.length + 1;
            
            for (let i = 0; i < 15; i++) {
                skeletonHtml += `<tr class="skeleton-row">`;
                skeletonHtml += `<td class="sticky-col"><div class="skeleton-cell"></div></td>`;
                
                for (let j = 0; j < columnsCount - 1; j++) {
                    skeletonHtml += `<td><div class="skeleton-cell ${j % 3 === 0 ? 'wide' : ''}"></div></td>`;
                }
                
                skeletonHtml += `</tr>`;
            }
            document.getElementById('tableBody').innerHTML = skeletonHtml;
        };

        let fetchData = async (type) => {
            showSkeleton();
            try {
                let endpoint = type === 'dn' ? DN_ENDPOINT : GR_ENDPOINT;
                let response = await fetch(endpoint);
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                let result = await response.json();
                if (result.success && result.data) {
                    allData[type] = result.data;
                    renderTableHeaders(type);
                    applyFiltersAndSort();
                } else {
                    document.getElementById('tableBody').innerHTML = '<tr><td colspan="30" class="center-align">No data found.</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="30" class="center-align">Failed to load data. ${error.message}</td></tr>`;
            }
        };

        let renderTableHeaders = (type) => {
            let headers = type === 'dn' ? dnHeaders : grHeaders;
            let headerHtml = `<tr><th class="sticky-col">Action</th>`;
            
            headers.forEach(header => {
                headerHtml += `<th data-sort="${header.key}">${header.label} <span class="sort-icon material-icons"></span></th>`;
            });
            
            headerHtml += `</tr>`;
            document.getElementById('tableHeader').innerHTML = headerHtml;
            
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.onclick = () => handleSort(header.dataset.sort);
            });
        };

        let renderTable = (dataToRender) => {
            let fragment = document.createDocumentFragment();
            let tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            dataToRender.forEach(rowData => {
                let row = document.createElement('tr');
                row.setAttribute('data-id', rowData.id || rowData.DO_NO || rowData.PO_NO);

                let actionCell = document.createElement('td');
                actionCell.className = 'sticky-col';
                
                let dropdownHtml = `
                    <a class='dropdown-trigger btn btn-action' href='#' data-target='dropdown-${rowData.id}'>
                        Actions <i class="material-icons right">arrow_drop_down</i>
                    </a>
                    <ul id='dropdown-${rowData.id}' class='dropdown-content'>
                        <li><a href="#!" onclick="recheckDO('${rowData.DO_NO || rowData.PO_NO}')"><i class="material-icons">refresh</i> Recheck</a></li>
                        <li><a href="#!" onclick="showDetails(${rowData.id})"><i class="material-icons">info</i> Details</a></li>
                    </ul>
                `;
                actionCell.innerHTML = dropdownHtml;
                row.appendChild(actionCell);

                let headers = currentTab === 'dn' ? dnHeaders : grHeaders;
                headers.forEach(header => {
                    let cell = document.createElement('td');
                    let value = rowData[header.key];
                    
                    if (value === null || value === undefined) {
                        cell.textContent = '';
                    } else if (typeof value === 'boolean') {
                        cell.textContent = value ? 'Yes' : 'No';
                    } else if (header.key.includes('date') || header.key.includes('created') || header.key.includes('updated')) {
                        try {
                            let date = new Date(value);
                            cell.textContent = isNaN(date.getTime()) ? value : date.toLocaleString();
                        } catch {
                            cell.textContent = value;
                        }
                    } else {
                        cell.textContent = value;
                    }
                    
                    row.appendChild(cell);
                });

                fragment.appendChild(row);
            });
            
            tableBody.appendChild(fragment);
            
            document.querySelectorAll('.dropdown-trigger').forEach(elem => {
                M.Dropdown.init(elem, { constrainWidth: false });
            });
            
            if (document.querySelector('.geserkk')) {
                initHorizontalScroll(document.querySelector('.geserkk'));
            }
        };

        let initHorizontalScroll = (element) => {
            let isDown = false;
            let startX;
            let scrollLeft;

            element.onmousedown = (e) => {
                isDown = true;
                element.classList.add('kgrab');
                startX = e.pageX - element.offsetLeft;
                scrollLeft = element.scrollLeft;
            };

            element.onmouseleave = () => {
                isDown = false;
                element.classList.remove('kgrab');
            };

            element.onmouseup = () => {
                isDown = false;
                element.classList.remove('kgrab');
            };

            element.onmousemove = (e) => {
                if (!isDown) return;
                e.preventDefault();
                let x = e.pageX - element.offsetLeft;
                let walk = (x - startX) * 3;
                element.scrollLeft = scrollLeft - walk;
            };
        };

        let handleSort = (column) => {
            let sortIcon = document.querySelector(`th[data-sort="${column}"] .sort-icon`);
            
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = '';
            });

            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            if (sortIcon) {
                sortIcon.textContent = currentSortDirection === 'asc' ? 'arrow_drop_up' : 'arrow_drop_down';
            }

            applyFiltersAndSort();
        };

        let handleSearch = () => {
            clearTimeout(window.searchDebounce);
            window.searchDebounce = setTimeout(() => {
                applyFiltersAndSort();
            }, 300);
        };

        let applyFiltersAndSort = () => {
            let dataToFilter = [...allData[currentTab]];
            let searchTerm = document.getElementById('searchInput').value.toLowerCase();

            if (searchTerm) {
                dataToFilter = dataToFilter.filter(row => {
                    return Object.values(row).some(value => {
                        if (value === null || value === undefined) return false;
                        return String(value).toLowerCase().includes(searchTerm);
                    });
                });
            }

            if (currentSortColumn) {
                dataToFilter.sort((a, b) => {
                    let valA = a[currentSortColumn];
                    let valB = b[currentSortColumn];

                    if (valA === null || valA === undefined) return currentSortDirection === 'asc' ? 1 : -1;
                    if (valB === null || valB === undefined) return currentSortDirection === 'asc' ? -1 : 1;

                    if (typeof valA === 'string' && typeof valB === 'string') {
                        return currentSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    } else {
                        return currentSortDirection === 'asc' ? valA - valB : valB - valA;
                    }
                });
            }

            displayedData = dataToFilter;
            renderTable(displayedData);
        };

        let recheckDO = async (docNo) => {
            if (!docNo) return;
            
            modalInstance.open();
            document.getElementById('recheckModalContent').innerHTML = `
                <div class="progress"><div class="indeterminate"></div></div>
                <p class="center-align">Checking Document Number: ${docNo}</p>
            `;

            try {
                let response = await fetch(`${RECHECK_ENDPOINT}${docNo}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                let result = await response.json();
                let detailHtml = `
                    <p><strong>Document Number:</strong> ${docNo}</p>
                    <p><strong>Status:</strong> ${result.status || 'N/A'}</p>
                    <p><strong>Message:</strong> ${result.message || 'No message provided.'}</p>
                `;
                document.getElementById('recheckModalContent').innerHTML = detailHtml;
            } catch (error) {
                console.error('Error during recheck:', error);
                document.getElementById('recheckModalContent').innerHTML = `
                    <div class="red-text">
                        <p><strong>Failed to recheck Document Number:</strong> ${docNo}</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        };

        let showDetails = (id) => {
            let data = displayedData.find(item => item.id === id);
            if (!data) return;
            
            modalInstance.open();
            let detailHtml = `<div class="collection">`;
            
            for (let key in data) {
                if (data.hasOwnProperty(key)) {
                    let value = data[key];
                    if (value === null || value === undefined) continue;
                    
                    if (key.includes('date') || key.includes('created') || key.includes('updated')) {
                        try {
                            let date = new Date(value);
                            value = isNaN(date.getTime()) ? value : date.toLocaleString();
                        } catch {
                            // Keep original value if date parsing fails
                        }
                    }
                    
                    detailHtml += `
                        <div class="collection-item">
                            <strong>${key}:</strong> ${value}
                        </div>
                    `;
                }
            }
            
            detailHtml += `</div>`;
            document.getElementById('recheckModalContent').innerHTML = detailHtml;
        };

        let exportToExcel = () => {
            if (displayedData.length === 0) {
                M.toast({ html: 'No data to export', classes: 'red' });
                return;
            }

            let headers = currentTab === 'dn' ? dnHeaders : grHeaders;
            let headerLabels = ['Action', ...headers.map(h => h.label)];
            let csvContent = [headerLabels.join(',')];

            displayedData.forEach(row => {
                let rowValues = [''];
                headers.forEach(header => {
                    let value = row[header.key];
                    if (value === null || value === undefined) {
                        rowValues.push('');
                    } else if (header.key.includes('date') || header.key.includes('created') || header.key.includes('updated')) {
                        try {
                            let date = new Date(value);
                            rowValues.push(isNaN(date.getTime()) ? `"${value}"` : `"${date.toLocaleString()}"`);
                        } catch {
                            rowValues.push(`"${value}"`);
                        }
                    } else {
                        rowValues.push(`"${value}"`);
                    }
                });
                csvContent.push(rowValues.join(','));
            });

            let blob = new Blob([csvContent.join('\n')], { type: 'text/csv;charset=utf-8;' });
            let link = document.createElement('a');
            let url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `coldspace_${currentTab}_data.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        let handleTableKeydown = (event) => {
            if (event.target.id !== 'tableContainer') return;
            
            let scrollStep = 100;
            if (event.key === 'ArrowRight') {
                document.getElementById('tableContainer').scrollLeft += scrollStep;
                event.preventDefault();
            } else if (event.key === 'ArrowLeft') {
                document.getElementById('tableContainer').scrollLeft -= scrollStep;
                event.preventDefault();
            }
        };
    </script>
</body>
</html>