<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Coldspace Data</title>
    <meta name="viewport" content="initial-scale=1, minimum-scale=1, maximum-scale=5, width=device-width">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
            font-family: "Poppins", sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .app-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #f0f2f5;
        }
        .header-bar {
            display: flex;
            align-items: center;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 100;
            background: #fff;
            padding: 5px;
        }
        .header-bar .search-container {
            flex-grow: 1;
            position: relative;
        }
        .header-bar .search-container input {
            border: none;
            height: 40px;
            padding: 0 16px 0 48px !important;
            color: #333;
            width: calc(100% - 64px);
            margin:0;
        }
        .header-bar .search-container i.material-icons {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        .header-bar .search-container input:focus{border:none!important;box-shadow:none!important;}
        .header-bar .search-container input:focus ~ i.material-icons {
            color: #075e54;
        }
        .modal .modal-content .notes-item {
            margin: 18px 0 10px;
            border: unset;
            background: #075e54;
            padding: 8px 10px;
            display: block;
            border-radius: 8px;
            text-transform: uppercase;
            color: #fff;
        }
        .modal-footer > * {
            display: block;
            width: 50%;
            text-align: center;
        }
        .tabs-container {
            display: flex;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 50px; 
            z-index: 90;
        }
        .tabs-container .tab-link {
            flex: 1;
            text-align: center;
            padding: 3px 0 8px;
            color: #555;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }
        .tabs-container .tab-link.active {
            color: #075e54;
        }
        .tabs-container .tab-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #075e54;
        }
        .content-container {
            overflow-y: auto;
            padding: 16px;
            flex-grow: 1;
        }
        .data-card {
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .data-card:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .data-card:active {
            transform: scale(0.98);
        }
        .data-card .card-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-card .card-subtitle {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }
        .data-card .card-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #555;
        }
        .status-badge {
            font-size: 11px;
            padding: 3px 6px;
            border-radius: 10px;
            font-weight: bold;
            white-space: nowrap;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .warning {
            background-color: #fff8e1;
            color: #f57f17;
        }
        .modal.bottom-sheet {
            max-height: 80%;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 24px;
        }
        .modal .modal-content {padding: 0!important; margin-bottom:80px;}
        .modal .modal-content h4 {
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            padding-bottom: 16px;
            margin-bottom: 16px;
            margin-top: 0;
            color: #333;
        }
        .modal .modal-content .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal .modal-content .detail-item strong {
            font-weight: 500;
            color: #555;
        }
        .modal .modal-content .detail-item.notes-item strong {
            text-align: left;
            flex-basis: 30%;
        }
        .modal .modal-content .detail-item.notes-item span {
            text-align: left;
            flex-grow: 1;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 16px 24px;
            background-color: #ffffff;
            box-shadow: 0 -2px 5px 0 rgba(0,0,0,0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }
        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            z-index: 1000;
        }
        .connected {
            background-color: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }
        .disconnected {
            background-color: #f44336;
            box-shadow: 0 0 8px #f44336;
        }
        .toast-update {
            background-color: #075e54;
            color: white;
            border-radius: 20px;
            padding: 10px 20px;
        }
        .refresh-btn {
            margin-right: 10px;
            color: #075e54;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header-bar">
            <div class="search-container">
                <i class="material-icons">search</i>
                <input type="text" id="searchInput" placeholder="Search data..." oninput="handleSearch()">
            </div>
            <i class="material-icons refresh-btn" onclick="refreshData()" title="Refresh data">refresh</i>
            <i class="material-icons" onclick="exportToExcel()" title="Export to Excel">download</i>
        </div>

        <div class="tabs-container">
            <div class="tab-link active" onclick="switchTab('dn')">DN</div>
            <div class="tab-link" onclick="switchTab('gr')">GR</div>
        </div>

        <div class="content-container" id="content-container">
            <div id="data-list-loader" class="center-align" style="padding-top: 50px;">
                <div class="preloader-wrapper big active">
                    <div class="spinner-layer spinner-blue-only">
                        <div class="circle-clipper left"><div class="circle"></div></div>
                        <div class="gap-patch"><div class="circle"></div></div>
                        <div class="circle-clipper right"><div class="circle"></div></div>
                    </div>
                </div>
            </div>
            <div id="data-list"></div>
        </div>
    </div>
    
    <div id="detailModal" class="modal bottom-sheet">
        <div class="modal-content">
            <h4>Details</h4>
            <div id="modalContent"></div>
        </div>
        <div class="modal-footer">
            <button class="btn waves-effect waves-light" onclick="recheckItem()">Retry</button>
            <a href="#!" class="modal-close waves-effect waves-grey btn-flat">Close</a>
        </div>
    </div>

    <div id="connectionStatus" class="connection-status disconnected" title="Disconnected"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script>
        let formatDate = dateString =>
        (dateString?.length === 6 && !isNaN(dateString))
            ? `${dateString.substring(4, 6)}-${dateString.substring(2, 4)}-20${dateString.substring(0, 2)}`
            : '-';

        let levenshtein = (a, b) => {
            let [an, bn] = [a.length, b.length];
            let matrix = Array(bn + 1).fill(null).map(() => Array(an + 1).fill(null));
            for (let i = 0; i <= an; i++) matrix[0][i] = i;
            for (let j = 0; j <= bn; j++) matrix[j][0] = j;
            for (let j = 1; j <= bn; j++) {
                for (let i = 1; i <= an; i++) {
                    let cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + cost);
                }
            }
            return matrix[bn][an];
        };

        let allData = { dn: [], gr: [] };
        let displayedData = [];
        let currentTab = 'dn';
        let modalInstance = null;
        let ws = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let selectedItemForModal = null;
        let lastUpdateTime = null;
        let API_BASE_URL = 'https://cute-mature-shrew.ngrok-free.app/api/';
        let DN_ENDPOINT = API_BASE_URL + 'tarikandn';
        let GR_ENDPOINT = API_BASE_URL + 'tarikangr';

        let connectWebSocket = () => {
            try {
                let WS_URL = 'wss://rightly-composed-marlin.ngrok-free.app';
                ws = new WebSocket(WS_URL);
                ws.onopen = () => {
                    console.log('WebSocket connection established');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;
                    M.toast({ html: 'Connected to server', classes: 'rounded' });
                };
                ws.onmessage = event => {
                    try {
                        let data = JSON.parse(event.data);
                        (data.dn && data.grpo)
                            ? processDataUpdate(data)
                            : data.dn ? processPartialUpdate(data.dn, 'dn') : data.grpo && processPartialUpdate(data.grpo, 'gr');
                    } catch (error) {
                        console.error('Error processing WebSocket message:', error);
                    }
                };
                ws.onclose = () => {
                    console.log('WebSocket connection closed');
                    updateConnectionStatus(false);
                    if (reconnectAttempts < maxReconnectAttempts) {
                        let delay = Math.pow(2, reconnectAttempts) * 1000;
                        reconnectAttempts++;
                        console.log(`Attempting to reconnect in ${delay / 1000} seconds (${reconnectAttempts}/${maxReconnectAttempts})`);
                        setTimeout(connectWebSocket, delay);
                    } else {
                        M.toast({ html: 'Unable to connect to server', classes: 'red rounded' });
                    }
                };
                ws.onerror = error => {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                };
            } catch (error) {
                console.error('Error establishing WebSocket connection:', error);
            }
        };

        let processDataUpdate = data => {
            lastUpdateTime = new Date();
            data.dn && (allData.dn = data.dn);
            data.grpo && (allData.gr = data.grpo);
            showUpdateNotification();
            ((currentTab === 'dn' && data.dn) || (currentTab === 'gr' && data.grpo)) && applyFiltersAndSort();
            hideLoader();
        };

        let processPartialUpdate = (newData, type) => {
            lastUpdateTime = new Date();
            newData.forEach(newItem => {
                let existingIndex = allData[type].findIndex(item => item.id === newItem.id);
                existingIndex !== -1 ? allData[type][existingIndex] = newItem : allData[type].push(newItem);
            });
            showUpdateNotification();
            (currentTab === type) && applyFiltersAndSort();
        };

        let showUpdateNotification = () => {
            if (document.hidden) {
                ('Notification' in window && Notification.permission === 'granted') &&
                    new Notification('Coldspace Data Updated', { body: 'New data is available', icon: '/favicon.ico' });
            }
            M.toast({ html: `Data updated at ${lastUpdateTime.toLocaleTimeString()}`, classes: 'toast-update rounded' });
        };

        let updateConnectionStatus = connected => {
            let statusElement = document.getElementById('connectionStatus');
            statusElement.className = connected ? 'connection-status connected' : 'connection-status disconnected';
            statusElement.title = connected ? 'Connected' : 'Disconnected';
        };

        let loadInitialData = () => {
            showLoader();
            let requestHeaders = new Headers();
            requestHeaders.append('ngrok-skip-browser-warning', 'true');
            Promise.all([
                fetch(DN_ENDPOINT, { headers: requestHeaders }).then(response => response.json()),
                fetch(GR_ENDPOINT, { headers: requestHeaders }).then(response => response.json())
            ])
            .then(([dnData, grData]) => {
                Array.isArray(dnData) && (allData.dn = dnData);
                Array.isArray(grData) && (allData.gr = grData);
                applyFiltersAndSort();
            })
            .catch(error => {
                console.error('Error loading initial data:', error);
                hideLoader();
                document.getElementById('data-list').innerHTML = `<p class="center-align red-text">Error loading data: ${error.message}</p>`;
            });
        };

        let switchTab = tab => {
            currentTab = tab;
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab-link[onclick="switchTab('${tab}')"]`).classList.add('active');
            applyFiltersAndSort();
        };

        let refreshData = () => {
            M.toast({ html: 'Requesting latest data...', classes: 'rounded' });
            showLoader();
            (ws && ws.readyState === WebSocket.OPEN) ? ws.send(JSON.stringify({ type: 'request_data' })) : loadInitialData();
        };

        let showLoader = () => {
            document.getElementById('data-list').innerHTML = '';
            document.getElementById('data-list-loader').style.display = 'block';
        };

        let hideLoader = () => {
            document.getElementById('data-list-loader').style.display = 'none';
        };

        let renderDataCards = () => {
            hideLoader();
            let dataList = document.getElementById('data-list');
            dataList.innerHTML = displayedData.length === 0 ? '<p class="center-align">No data found</p>' : '';
            if (displayedData.length === 0) return;

            displayedData.forEach(row => {
                let title, subtitle, mainInfo, subInfo;
                let statusBadge = getStatusBadge(row.jo_status);
                if (currentTab === 'dn') {
                    [title, subtitle, mainInfo, subInfo] = [
                        row.DO_NO || '-',
                        `STO: ${row.STO_NO || '-'}`,
                        `SKU: ${row.SKU || '-'}`,
                        `Qty: ${row.QTY || '-'} | Exp: ${formatDate(row.expired_date)}`
                    ];
                } else if (currentTab === 'gr') {
                    [title, subtitle, mainInfo, subInfo] = [
                        row.PO_NO || '-',
                        `ASN: ${row.WMS_ASN_NO || '-'}`,
                        `Vendor: ${row.VENDOR || '-'}`,
                        `GR Qty: ${row.QTYGR || '-'} | Exp: ${formatDate(row.VFDAT)}`
                    ];
                }
                dataList.innerHTML += `
                    <div class="data-card" onclick="showDetails('${row.id}')">
                        <div class="card-title">
                            <span>${title}</span>
                            <span>${statusBadge}</span>
                        </div>
                        <div class="card-subtitle">${subtitle}</div>
                        <div class="card-info">
                            <span>${mainInfo}</span>
                            <span>${subInfo}</span>
                        </div>
                    </div>`;
            });
        };

        let getStatusBadge = status => {
            if (!status) return '';
            let s = status.toString().toLowerCase();
            return s.includes('complete') || s.includes('success') || s === '3'
                ? '<span class="status-badge success">Completed</span>'
                : s.includes('error') || s.includes('fail') || s === '0'
                    ? '<span class="status-badge error">Failed</span>'
                    : '<span class="status-badge warning">Processing</span>';
        };

        let handleSearch = () => {
            clearTimeout(window.searchTimer);
            window.searchTimer = setTimeout(applyFiltersAndSort, 300);
        };

        let applyFiltersAndSort = () => {
            let data = [...allData[currentTab]];
            let searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let threshold = 0.3;
            if (searchTerm) {
                let searchKeywords = searchTerm.split(' ').filter(word => word.length > 1);
                data = data.filter(row =>
                    searchKeywords.every(keyword =>
                        Object.values(row).some(value => {
                            if (value === null || value === undefined) return false;
                            let cellValue = String(value).toLowerCase();
                            return cellValue.includes(keyword) ||
                                cellValue.split(' ').some(word =>
                                    (Math.max(word.length, keyword.length) > 0
                                        ? levenshtein(word, keyword) / Math.max(word.length, keyword.length)
                                        : 1) <= threshold
                                );
                        })
                    )
                );
            }
            displayedData = data;
            renderDataCards();
        };

        let showDetails = id => {
            let item = displayedData.find(i => i.id == id);
            if (!item) return;
            selectedItemForModal = item;
            let isDN = currentTab === 'dn';
            let columns = isDN
                ? [{ key: 'DO_NO', label: 'DO Number' }, { key: 'STO_NO', label: 'STO Number' }, { key: 'COMP_CODE', label: 'Company Code' }, { key: 'PL_NP', label: 'PL Number' }, { key: 'DEL_DATE', label: 'Delivery Date' }, { key: 'SITE', label: 'Site' }, { key: 'SKU', label: 'SKU' }, { key: 'QTY', label: 'Quantity' }, { key: 'LOT', label: 'LOT' }, { key: 'expired_date', label: 'Expiry Date' }, { key: 'ismatch', label: 'Match Status' }, { key: 'jo_status', label: 'Status' }, { key: 'note', label: 'Notes' }]
                : [{ key: 'PO_NO', label: 'PO Number' }, { key: 'WMS_ASN_NO', label: 'ASN Number' }, { key: 'COMP_CODE', label: 'Company Code' }, { key: 'RR_DATE', label: 'Receipt Date' }, { key: 'VENDOR', label: 'Vendor' }, { key: 'SKU', label: 'SKU' }, { key: 'QTYPO', label: 'PO Quantity' }, { key: 'QTYGR', label: 'GR Quantity' }, { key: 'SLOC', label: 'Storage Loc' }, { key: 'VFDAT', label: 'Expiry Date' }, { key: 'ismatch', label: 'Match Status' }, { key: 'jo_status', label: 'Status' }, { key: 'note', label: 'Notes' }];

            let modalContent = columns.map(col => {
                let value = item[col.key];
                value = ['DEL_DATE', 'expired_date', 'VFDAT', 'RR_DATE'].includes(col.key)
                    ? formatDate(value)
                    : col.key === 'ismatch'
                        ? (value ? 'Matched' : 'Mismatch')
                        : value || '-';
                return `<div class="detail-item ${col.key === 'note' ? 'notes-item' : ''}"><span>${col.label}: </span><span>${value}</span></div>`;
            }).join('');
            document.getElementById('modalContent').innerHTML = modalContent;
            modalInstance.open();
        };

        let recheckItem = () => {
            if (!selectedItemForModal) return;
            let { id, currentTab } = selectedItemForModal;
            M.toast({ html: `Rechecking ${currentTab.toUpperCase()} item ${id}...`, classes: 'rounded' });
            (ws && ws.readyState === WebSocket.OPEN)
                ? ws.send(JSON.stringify({ type: 'recheck', itemId: id, itemType: currentTab }))
                : M.toast({ html: 'Not connected to server', classes: 'red rounded' });
            modalInstance.close();
        };

        let exportToExcel = () => {
            if (displayedData.length === 0) {
                M.toast({ html: 'No data to export', classes: 'red rounded' });
                return;
            }
            let isDN = currentTab === 'dn';
            let columns = isDN
                ? [{ key: 'DO_NO', label: 'DO Number' }, { key: 'STO_NO', label: 'STO Number' }, { key: 'COMP_CODE', label: 'Company Code' }, { key: 'DEL_DATE', label: 'Delivery Date' }, { key: 'SKU', label: 'SKU' }, { key: 'QTY', label: 'Quantity' }, { key: 'LOT', label: 'LOT' }, { key: 'expired_date', label: 'Expiry Date' }, { key: 'jo_status', label: 'Status' }, { key: 'note', label: 'Notes' }]
                : [{ key: 'PO_NO', label: 'PO Number' }, { key: 'COMP_CODE', label: 'Company Code' }, { key: 'RR_DATE', label: 'Receipt Date' }, { key: 'VENDOR', label: 'Vendor' }, { key: 'SKU', label: 'SKU' }, { key: 'QTYGR', label: 'GR Quantity' }, { key: 'SLOC', label: 'Storage Loc' }, { key: 'VFDAT', label: 'Expiry Date' }, { key: 'jo_status', label: 'Status' }, { key: 'note', label: 'Notes' }];
            let sheetName = isDN ? 'DeliveryNotes' : 'GoodsReceipts';
            let excelData = [columns.map(col => col.label)];
            displayedData.forEach(row => {
                let rowData = columns.map(col => ['DEL_DATE', 'expired_date', 'VFDAT', 'RR_DATE'].includes(col.key) ? formatDate(row[col.key]) : row[col.key] || '');
                excelData.push(rowData);
            });
            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.aoa_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `Coldspace_${sheetName}_Data.xlsx`);
        };

        document.addEventListener('DOMContentLoaded', () => {
            if ('Notification' in window) Notification.requestPermission();
        });

        window.onload = () => {
            modalInstance = M.Modal.init(document.getElementById('detailModal'));
            loadInitialData();
            connectWebSocket();
            setInterval(() => {
                (ws && ws.readyState === WebSocket.OPEN) && ws.send(JSON.stringify({ type: 'request_data' }));
            }, 30000);
        };
    </script>
    <!-- <script>
        let formatDate = dateString => (dateString?.length === 6 && !isNaN(dateString)) ? `${dateString.substring(4, 6)}-${dateString.substring(2, 4)}-20${dateString.substring(0, 2)}` : '-';

        function levenshtein(a, b) {
            const an = a.length;
            const bn = b.length;
            const matrix = Array(bn + 1).fill(null).map(() => Array(an + 1).fill(null));
            for (let i = 0; i <= an; i++) {
                matrix[0][i] = i;
            }
            for (let j = 0; j <= bn; j++) {
                matrix[j][0] = j;
            }
            for (let j = 1; j <= bn; j++) {
                for (let i = 1; i <= an; i++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j][i - 1] + 1,
                        matrix[j - 1][i] + 1,
                        matrix[j - 1][i - 1] + cost
                    );
                }
            }
            return matrix[bn][an];
        }

        let allData = { dn: [], gr: [] };
        let displayedData = [];
        let currentTab = 'dn';
        let modalInstance = null;
        let ws = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let selectedItemForModal = null;
        let lastUpdateTime = null;
        let API_BASE_URL = 'https://cute-mature-shrew.ngrok-free.app/api/';
        let DN_ENDPOINT = API_BASE_URL + 'tarikandn';
        let GR_ENDPOINT = API_BASE_URL + 'tarikangr';

        function connectWebSocket() {
            try {
                const WS_URL = 'wss://rightly-composed-marlin.ngrok-free.app';
                ws = new WebSocket(WS_URL);

                ws.onopen = function() {
                    console.log('WebSocket connection established');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;
                    M.toast({html: 'Connected to server', classes: 'rounded'});
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.dn && data.grpo) {
                            processDataUpdate(data);
                        } else if (data.dn || data.grpo) {
                            if (data.dn) {
                                processPartialUpdate(data.dn, 'dn');
                            }
                            if (data.grpo) {
                                processPartialUpdate(data.grpo, 'gr');
                            }
                        }
                    } catch (error) {
                        console.error('Error processing WebSocket message:', error);
                    }
                };

                ws.onclose = function() {
                    console.log('WebSocket connection closed');
                    updateConnectionStatus(false);
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        const delay = Math.pow(2, reconnectAttempts) * 1000;
                        reconnectAttempts++;
                        console.log(`Attempting to reconnect in ${delay/1000} seconds (${reconnectAttempts}/${maxReconnectAttempts})`);
                        
                        setTimeout(() => {
                            connectWebSocket();
                        }, delay);
                    } else {
                        M.toast({html: 'Unable to connect to server', classes: 'red rounded'});
                    }
                };

                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                };
            } catch (error) {
                console.error('Error establishing WebSocket connection:', error);
            }
        }

        function processDataUpdate(data) {
            lastUpdateTime = new Date();
            
            if (data.dn) {
                allData.dn = data.dn;
            }
            if (data.grpo) {
                allData.gr = data.grpo;
            }
            
            showUpdateNotification();
            
            if ((currentTab === 'dn' && data.dn) || (currentTab === 'gr' && data.grpo)) {
                applyFiltersAndSort();
            }
            
            hideLoader();
        }

        function processPartialUpdate(newData, type) {
            lastUpdateTime = new Date();
            
            if (type === 'dn') {
                newData.forEach(newItem => {
                    const existingIndex = allData.dn.findIndex(item => item.id === newItem.id);
                    if (existingIndex !== -1) {
                        allData.dn[existingIndex] = newItem;
                    } else {
                        allData.dn.push(newItem);
                    }
                });
            } else if (type === 'gr') {
                newData.forEach(newItem => {
                    const existingIndex = allData.gr.findIndex(item => item.id === newItem.id);
                    if (existingIndex !== -1) {
                        allData.gr[existingIndex] = newItem;
                    } else {
                        allData.gr.push(newItem);
                    }
                });
            }
            
            showUpdateNotification();
            
            if (currentTab === type) {
                applyFiltersAndSort();
            }
        }

        function showUpdateNotification() {
            if (document.hidden) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Coldspace Data Updated', {
                        body: 'New data is available',
                        icon: '/favicon.ico'
                    });
                }
            }
            
            M.toast({
                html: `Data updated at ${lastUpdateTime.toLocaleTimeString()}`,
                classes: 'toast-update rounded'
            });
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.title = 'Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.title = 'Disconnected';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if ('Notification' in window) {
                Notification.requestPermission();
            }
        });

        window.onload = function() {
            modalInstance = M.Modal.init(document.getElementById('detailModal'));
            
            loadInitialData();
            connectWebSocket();
            
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({type: 'request_data'}));
                }
            }, 30000);
        };

        function loadInitialData() {
            showLoader();
            
            const requestHeaders = new Headers();
            requestHeaders.append('ngrok-skip-browser-warning', 'true');
            
            Promise.all([
                fetch(DN_ENDPOINT, { headers: requestHeaders }).then(response => response.json()),
                fetch(GR_ENDPOINT, { headers: requestHeaders }).then(response => response.json())
            ])
            .then(([dnData, grData]) => {
                if (Array.isArray(dnData)) {
                    allData.dn = dnData;
                }
                if (Array.isArray(grData)) {
                    allData.gr = grData;
                }
                applyFiltersAndSort();
            })
            .catch(error => {
                console.error('Error loading initial data:', error);
                hideLoader();
                document.getElementById('data-list').innerHTML = '<p class="center-align red-text">Error loading data: ' + error.message + '</p>';
            });
        }

        let switchTab = function(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-link').forEach(function(t) {
                t.classList.remove('active');
            });
            document.querySelector('.tab-link[onclick="switchTab(\'' + tab + '\')"]').classList.add('active');
            
            applyFiltersAndSort();
        };

        let refreshData = function() {
            M.toast({ html: 'Requesting latest data...', classes: 'rounded' });
            showLoader();
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: 'request_data'}));
            } else {
                loadInitialData();
            }
        };

        let showLoader = function() {
            document.getElementById('data-list').innerHTML = '';
            document.getElementById('data-list-loader').style.display = 'block';
        };

        let hideLoader = function() {
            document.getElementById('data-list-loader').style.display = 'none';
        };


        let renderDataCards = function() {
            hideLoader();
            const dataList = document.getElementById('data-list');
            dataList.innerHTML = '';
            if (displayedData.length === 0) {
                dataList.innerHTML = '<p class="center-align">No data found</p>';
                return;
            }

            displayedData.forEach(function(row) {
                let title, subtitle, mainInfo, subInfo;
                let statusBadge = getStatusBadge(row.jo_status);

                if (currentTab === 'dn') {
                    title = row.DO_NO || '-';
                    subtitle = `STO: ${row.STO_NO || '-'}`;
                    mainInfo = `SKU: ${row.SKU || '-'}`;
                    subInfo = `Qty: ${row.QTY || '-'} | Exp: ${formatDate(row.expired_date)}`;
                } else if (currentTab === 'gr') {
                    title = row.PO_NO || '-';
                    subtitle = `ASN: ${row.WMS_ASN_NO || '-'}`;
                    mainInfo = `Vendor: ${row.VENDOR || '-'}`;
                    subInfo = `GR Qty: ${row.QTYGR || '-'} | Exp: ${formatDate(row.VFDAT)}`;
                } else {
                    return;
                }

                dataList.innerHTML += `
                    <div class="data-card" onclick="showDetails('${row.id}')">
                        <div class="card-title">
                            <span>${title}</span>
                            <span>${statusBadge}</span>
                        </div>
                        <div class="card-subtitle">${subtitle}</div>
                        <div class="card-info">
                            <span>${mainInfo}</span>
                            <span>${subInfo}</span>
                        </div>
                    </div>
                `;
            });
        };

        let getStatusBadge = function(status) {
            if (!status) return '';
            status = status.toString().toLowerCase();
            if (status.includes('complete') || status.includes('success') || status === '3') {
                return '<span class="status-badge success">Completed</span>';
            } else if (status.includes('error') || status.includes('fail') || status === '0') {
                return '<span class="status-badge error">Failed</span>';
            } else {
                return '<span class="status-badge warning">Processing</span>';
            }
        };

        let handleSearch = function() {
            clearTimeout(window.searchTimer);
            window.searchTimer = setTimeout(function() {
                applyFiltersAndSort();
            }, 300);
        };

        let applyFiltersAndSort = function() {
            let data = [...allData[currentTab]];
            let searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const threshold = 0.3;

            if (searchTerm) {
                const searchKeywords = searchTerm.split(' ').filter(word => word.length > 1);

                data = data.filter(function(row) {
                    return searchKeywords.every(keyword => {
                        return Object.values(row).some(value => {
                            if (value === null || value === undefined) return false;
                            const cellValue = String(value).toLowerCase();
                            
                            if (cellValue.includes(keyword)) {
                                return true;
                            }
                            
                            const wordsInCell = cellValue.split(' ');
                            return wordsInCell.some(word => {
                                const distance = levenshtein(word, keyword);
                                const maxLen = Math.max(word.length, keyword.length);
                                const relativeDistance = maxLen > 0 ? distance / maxLen : 1;
                                return relativeDistance <= threshold;
                            });
                        });
                    });
                });
            }
            displayedData = data;
            renderDataCards();
        };

        let showDetails = function(id) {
            let item = displayedData.find(function(i) { return i.id == id; });
            if (!item) return;
            selectedItemForModal = item;

            let modalContent = '';
            let columns = [];
            
            if (currentTab === 'dn') {
                columns = [
                    { key: 'DO_NO', label: 'DO Number' },
                    { key: 'STO_NO', label: 'STO Number' },
                    { key: 'COMP_CODE', label: 'Company Code' },
                    { key: 'PL_NP', label: 'PL Number' },
                    { key: 'DEL_DATE', label: 'Delivery Date' },
                    { key: 'SITE', label: 'Site' },
                    { key: 'SKU', label: 'SKU' },
                    { key: 'QTY', label: 'Quantity' },
                    { key: 'LOT', label: 'LOT' },
                    { key: 'expired_date', label: 'Expiry Date' },
                    { key: 'ismatch', label: 'Match Status' },
                    { key: 'jo_status', label: 'Status' },
                    { key: 'note', label: 'Notes' },
                ];
            } else if (currentTab === 'gr') {
                columns = [
                    { key: 'PO_NO', label: 'PO Number' },
                    { key: 'WMS_ASN_NO', label: 'ASN Number' },
                    { key: 'COMP_CODE', label: 'Company Code' },
                    { key: 'RR_DATE', label: 'Receipt Date' },
                    { key: 'VENDOR', label: 'Vendor' },
                    { key: 'SKU', label: 'SKU' },
                    { key: 'QTYPO', label: 'PO Quantity' },
                    { key: 'QTYGR', label: 'GR Quantity' },
                    { key: 'SLOC', label: 'Storage Loc' },
                    { key: 'VFDAT', label: 'Expiry Date' },
                    { key: 'ismatch', label: 'Match Status' },
                    { key: 'jo_status', label: 'Status' },
                    { key: 'note', label: 'Notes' }
                ];
            }

            columns.forEach(function(col) {
                let value = item[col.key];
                if (col.key.includes('DATE') || col.key.includes('expired_date') || col.key.includes('VFDAT')) {
                    value = formatDate(value);
                } else if (col.key === 'ismatch') {
                    value = value ? 'Matched' : 'Mismatch';
                }
                
                let notesClass = (col.key === 'note') ? 'notes-item' : '';
                modalContent += `<div class="detail-item ${notesClass}"><span>${value || '-'}</span></div>`;
            });
            document.getElementById('modalContent').innerHTML = modalContent;
            modalInstance.open();
        };

        let recheckItem = function() {
            if (!selectedItemForModal) return;
            const itemId = selectedItemForModal.id;
            const itemType = currentTab.toUpperCase();
            M.toast({ html: `Rechecking ${itemType} item ${itemId}...`, classes: 'rounded' });
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'recheck',
                    itemId: itemId,
                    itemType: currentTab
                }));
            } else {
                M.toast({ html: 'Not connected to server', classes: 'red rounded' });
            }
            
            modalInstance.close();
        };

        let exportToExcel = function() {
            if (displayedData.length === 0) {
                M.toast({ html: 'No data to export', classes: 'red rounded' });
                return;
            }
            
            let columns;
            let sheetName;
            if (currentTab === 'dn') {
                columns = [
                    { key: 'DO_NO', label: 'DO Number' },
                    { key: 'STO_NO', label: 'STO Number' },
                    { key: 'COMP_CODE', label: 'Company Code' },
                    { key: 'DEL_DATE', label: 'Delivery Date' },
                    { key: 'SKU', label: 'SKU' },
                    { key: 'QTY', label: 'Quantity' },
                    { key: 'LOT', label: 'LOT' },
                    { key: 'expired_date', label: 'Expiry Date' },
                    { key: 'jo_status', label: 'Status' },
                    { key: 'note', label: 'Notes' }
                ];
                sheetName = 'DeliveryNotes';
            } else if (currentTab === 'gr') {
                columns = [
                    { key: 'PO_NO', label: 'PO Number' },
                    { key: 'COMP_CODE', label: 'Company Code' },
                    { key: 'RR_DATE', label: 'Receipt Date' },
                    { key: 'VENDOR', label: 'Vendor' },
                    { key: 'SKU', label: 'SKU' },
                    { key: 'QTYGR', label: 'GR Quantity' },
                    { key: 'SLOC', label: 'Storage Loc' },
                    { key: 'VFDAT', label: 'Expiry Date' },
                    { key: 'jo_status', label: 'Status' },
                    { key: 'note', label: 'Notes' }
                ];
                sheetName = 'GoodsReceipts';
            } else {
                 return;
            }

            let excelData = [
                columns.map(function(col) { return col.label; })
            ];

            displayedData.forEach(function(row) {
                let rowData = columns.map(function(col) {
                    let value = row[col.key];
                    if (col.key.includes('DATE') || col.key.includes('expired_date') || col.key.includes('VFDAT')) {
                        return formatDate(value);
                    }
                    return value || '';
                });
                excelData.push(rowData);
            });
            
            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.aoa_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, 'Coldspace_' + sheetName + '_Data.xlsx');
        };
    </script> -->
</body>
</html>