<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coldspace Data</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container-fluid {
            width: 100%;
            padding: 0 15px;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .tabs-export-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .tabs-row {
            display: flex;
            background: #f1f3f6;
            padding: 4px;
        }
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            text-align: center;
            min-width: 100px;
            white-space: nowrap;
        }
        .tab.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #3f51b5;
        }
        .input-field {
            margin-top: 0;
            margin-bottom: 0;
            flex-grow: 1;
            min-width: 250px;
        }
        .input-field label {
            pointer-events: none;
        }
        .input-field label.active {
            transform: translateY(-10px) scale(0.8);
        }
        .export-btn {
            background-color: #4caf50;
            white-space: nowrap;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 0;
        }
        th {
            background-color: #3f51b5;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th.action-cell {
            position: sticky;
            left: 0;
            z-index: 30;
            background-color: #3f51b5;
            color: white;
            box-shadow: 2px 0 3px -1px rgba(0,0,0,0.1);
        }
        td.action-cell {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: white;
            box-shadow: 2px 0 3px -1px rgba(0,0,0,0.1);
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .action-btn {
            padding: 0 10px;
            height: 30px;
            line-height: 30px;
            font-size: 13px;
        }
        .dropdown-content {
            min-width: 140px;
            z-index: 999;
        }
        .sort-icon {
            margin-left: 5px;
            vertical-align: middle;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 12px;
            font-weight: 500;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .warning {
            background-color: #fff8e1;
            color: #f57f17;
        }
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .tabs-export-container {
                width: 100%;
                justify-content: space-between;
            }
            .input-field {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="toolbar">
            <div class="input-field">
                <i class="material-icons prefix">search</i>
                <input type="text" id="searchInput" oninput="handleSearch()">
                <label for="searchInput">Search data...</label>
            </div>
            <div class="tabs-export-container">
                <div class="tabs-row">
                    <div class="tab active" onclick="switchTab('dn')">DN</div>
                    <div class="tab" onclick="switchTab('gr')">GR</div>
                </div>
                <button class="btn export-btn waves-effect" onclick="exportToExcel()">
                    <i class="material-icons left">file_download</i> Export Excel
                </button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <h4>Details</h4>
            <div id="modalContent"></div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-grey btn-flat">Close</a>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        function levenshtein(a, b) {
            const an = a.length;
            const bn = b.length;
            const matrix = Array(bn + 1).fill(null).map(() => Array(an + 1).fill(null));
            for (let i = 0; i <= an; i++) {
                matrix[0][i] = i;
            }
            for (let j = 0; j <= bn; j++) {
                matrix[j][0] = j;
            }
            for (let j = 1; j <= bn; j++) {
                for (let i = 1; i <= an; i++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j][i - 1] + 1,
                        matrix[j - 1][i] + 1,
                        matrix[j - 1][i - 1] + cost
                    );
                }
            }
            return matrix[bn][an];
        }

        let allData = { dn: [], gr: [] };
        let displayedData = [];
        let currentTab = 'dn';
        let currentSort = { column: null, direction: 'asc' };
        let modalInstance = null;

        let API_BASE_URL = 'https://cute-mature-shrew.ngrok-free.app/api/';
        let DN_ENDPOINT = API_BASE_URL + 'tarikandn';
        let GR_ENDPOINT = API_BASE_URL + 'tarikangr';

        window.onload = function() {
            modalInstance = M.Modal.init(document.getElementById('detailModal'));
            M.updateTextFields();
            loadData('dn');
        };

        let switchTab = function(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(function(t) {
                t.classList.remove('active');
            });
            document.querySelector('.tab[onclick="switchTab(\'' + tab + '\')"]').classList.add('active');
            loadData(tab);
        };

        let loadData = function(type) {
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="20" class="center-align"><div class="progress"><div class="indeterminate"></div></div></td></tr>';
            let endpoint = type === 'dn' ? DN_ENDPOINT : GR_ENDPOINT;
            const requestHeaders = new Headers();
            requestHeaders.append('ngrok-skip-browser-warning', 'true');

            
            // fetch(endpoint)
            fetch(endpoint, { headers: requestHeaders })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (Array.isArray(data)) {
                        allData[type] = data;
                        renderTableHeaders(type);
                        applyFiltersAndSort();
                    } else {
                        throw new Error('API did not return array data');
                    }
                })
                .catch(function(error) {
                    console.error('Error loading data:', error);
                    document.getElementById('tableBody').innerHTML = '<tr><td colspan="20" class="center-align red-text">Error loading data: ' + error.message + '</td></tr>';
                });
        };

        let renderTableHeaders = function(type) {
            let columns = type === 'dn' ? [
                { key: 'DO_NO', label: 'DO Number' },
                { key: 'STO_NO', label: 'STO Number' },
                { key: 'PL_NP', label: 'PL Number' },
                { key: 'DEL_DATE', label: 'Delivery Date' },
                { key: 'SITE', label: 'Site' },
                { key: 'SKU', label: 'SKU' },
                { key: 'QTY', label: 'Quantity' },
                { key: 'LOT', label: 'LOT' },
                { key: 'expired_date', label: 'Expired Date' },
                { key: 'ismatch', label: 'Match Status' },
                { key: 'jo_status', label: 'Status' },
                { key: 'note', label: 'Notes' }
            ] : [
                { key: 'PO_NO', label: 'PO Number' },
                { key: 'WMS_ASN_NO', label: 'ASN Number' },
                { key: 'RR_DATE', label: 'Receipt Date' },
                { key: 'VENDOR', label: 'Vendor' },
                { key: 'SKU', label: 'SKU' },
                { key: 'QTYPO', label: 'PO Qty' },
                { key: 'QTYGR', label: 'GR Qty' },
                { key: 'SLOC', label: 'Storage Loc' },
                { key: 'VFDAT', label: 'Expiry Date' },
                { key: 'ismatch', label: 'Match Status' },
                { key: 'jo_status', label: 'Status' },
                { key: 'note', label: 'Notes' }
            ];

            let headerHtml = '<tr><th class="action-cell">Actions</th>';
            columns.forEach(function(col) {
                headerHtml += '<th onclick="sortTable(\'' + col.key + '\')">' + col.label + '<i class="material-icons sort-icon">' + (currentSort.column === col.key ? (currentSort.direction === 'asc' ? 'arrow_drop_up' : 'arrow_drop_down') : '') + '</i></th>';
            });
            headerHtml += '</tr>';
            document.getElementById('tableHeader').innerHTML = headerHtml;
        };

        let renderTableData = function() {
            let tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            if (displayedData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="20" class="center-align">No data found</td></tr>';
                return;
            }
            let columns = currentTab === 'dn' ? [
                'DO_NO', 'STO_NO', 'PL_NP', 'DEL_DATE', 'SITE', 'SKU', 'QTY', 
                'LOT', 'expired_date', 'ismatch', 'jo_status', 'note'
            ] : [
                'PO_NO', 'WMS_ASN_NO', 'RR_DATE', 'VENDOR', 'SKU', 'QTYPO', 
                'QTYGR', 'SLOC', 'VFDAT', 'ismatch', 'jo_status', 'note'
            ];
            displayedData.forEach(function(row) {
                let rowHtml = '<tr><td class="action-cell"><a class="dropdown-trigger btn action-btn waves-effect" href="#" data-target="actions-' + row.id + '">Actions <i class="material-icons right">arrow_drop_down</i></a><ul id="actions-' + row.id + '" class="dropdown-content"><li><a href="#!" onclick="showDetails(' + row.id + ')"><i class="material-icons">visibility</i> View</a></li><li><a href="#!" onclick="recheckItem(' + row.id + ')"><i class="material-icons">refresh</i> Recheck</a></li></ul></td>';
                columns.forEach(function(col) {
                    let value = row[col];
                    if (col.includes('DATE') || col.includes('created_at') || col.includes('updated_at')) {
                        value = formatDate(value);
                    } else if (col === 'ismatch') {
                        value = value ? '<span class="status-badge success">Matched</span>' : '<span class="status-badge error">Mismatch</span>';
                    } else if (col === 'jo_status') {
                        value = getStatusBadge(value);
                    }
                    rowHtml += '<td>' + (value || '') + '</td>';
                });
                rowHtml += '</tr>';
                tableBody.innerHTML += rowHtml;
            });
            document.querySelectorAll('.dropdown-trigger').forEach(function(elem) {
                M.Dropdown.init(elem, {
                    coverTrigger: false,
                    constrainWidth: false,
                    container: document.body
                });
            });
        };

        let formatDate = function(dateString) {
            if (!dateString) return '';
            try {
                let date = new Date(dateString);
                return date.toLocaleDateString();
            } catch {
                return dateString;
            }
        };

        let getStatusBadge = function(status) {
            if (!status) return '';
            status = status.toString().toLowerCase();
            if (status.includes('complete') || status.includes('success') || status === '3') {
                return '<span class="status-badge success">Completed</span>';
            } else if (status.includes('error') || status.includes('fail') || status === '0') {
                return '<span class="status-badge error">Failed</span>';
            } else {
                return '<span class="status-badge warning">Processing</span>';
            }
        };

        let sortTable = function(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            applyFiltersAndSort();
        };

        let handleSearch = function() {
            clearTimeout(window.searchTimer);
            window.searchTimer = setTimeout(function() {
                applyFiltersAndSort();
            }, 300);
        };

        let applyFiltersAndSort = function() {
            let data = [...allData[currentTab]];
            let searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const threshold = 0.3;

            if (searchTerm) {
                const searchKeywords = searchTerm.split(' ').filter(word => word.length > 1);

                data = data.filter(function(row) {
                    return searchKeywords.every(keyword => {
                        return Object.values(row).some(value => {
                            if (value === null || value === undefined) return false;
                            const cellValue = String(value).toLowerCase();
                            
                            // Cek kecocokan langsung
                            if (cellValue.includes(keyword)) {
                                return true;
                            }

                            // Cek kecocokan fuzzy
                            const wordsInCell = cellValue.split(' ');
                            return wordsInCell.some(word => {
                                const distance = levenshtein(word, keyword);
                                const maxLen = Math.max(word.length, keyword.length);
                                const relativeDistance = maxLen > 0 ? distance / maxLen : 1;
                                return relativeDistance <= threshold;
                            });
                        });
                    });
                });
            }

            if (currentSort.column) {
                data.sort(function(a, b) {
                    let valA = a[currentSort.column];
                    let valB = b[currentSort.column];
                    if (valA == null) return currentSort.direction === 'asc' ? 1 : -1;
                    if (valB == null) return currentSort.direction === 'asc' ? -1 : 1;
                    if (typeof valA === 'string' && typeof valB === 'string') {
                        return currentSort.direction === 'asc' ? 
                            valA.localeCompare(valB) : valB.localeCompare(valA);
                    } else {
                        return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                    }
                });
            }
            displayedData = data;
            renderTableData();
        };

        let showDetails = function(id) {
            let item = displayedData.find(function(i) { return i.id === id; });
            if (!item) return;
            let modalContent = '';
            let columns = currentTab === 'dn' ? [
                { key: 'DO_NO', label: 'DO Number' },
                { key: 'STO_NO', label: 'STO Number' },
                { key: 'COMP_CODE', label: 'Company Code' },
                { key: 'DEL_DATE', label: 'Delivery Date' },
                { key: 'SKU', label: 'SKU' },
                { key: 'QTY', label: 'Quantity' },
                { key: 'expired_date', label: 'Expiry Date' },
                { key: 'jo_status', label: 'Status' },
                { key: 'note', label: 'Notes' }
            ] : [
                { key: 'PO_NO', label: 'PO Number' },
                { key: 'COMP_CODE', label: 'Company Code' },
                { key: 'RR_DATE', label: 'Receipt Date' },
                { key: 'VENDOR', label: 'Vendor' },
                { key: 'SKU', label: 'SKU' },
                { key: 'QTYGR', label: 'GR Quantity' },
                { key: 'SLOC', label: 'Storage Loc' },
                { key: 'VFDAT', label: 'Expiry Date' },
                { key: 'jo_status', label: 'Status' },
                { key: 'note', label: 'Notes' }
            ];
            columns.forEach(function(col) {
                let value = item[col.key];
                if (col.key.includes('DATE') || col.key.includes('created_at') || col.key.includes('updated_at')) {
                    value = formatDate(value);
                }
                modalContent += '<div class="row" style="margin-bottom: 10px;"><div class="col s4"><strong>' + col.label + ':</strong></div><div class="col s8">' + (value || '-') + '</div></div>';
            });
            document.getElementById('modalContent').innerHTML = modalContent;
            modalInstance.open();
        };

        let recheckItem = function(id) {
            M.toast({ html: 'Rechecking item ' + id + '...', classes: 'rounded' });
        };

        let exportToExcel = function() {
            if (displayedData.length === 0) {
                M.toast({ html: 'No data to export', classes: 'red rounded' });
                return;
            }
            let columns = currentTab === 'dn' ? [
                { key: 'DO_NO', label: 'DO Number' },
                { key: 'STO_NO', label: 'STO Number' },
                { key: 'COMP_CODE', label: 'Company Code' },
                { key: 'DEL_DATE', label: 'Delivery Date' },
                { key: 'SKU', label: 'SKU' },
                { key: 'QTY', label: 'Quantity' },
                { key: 'LOT', label: 'LOT' },
                { key: 'expired_date', label: 'Expiry Date' },
                { key: 'jo_status', label: 'Status' },
                { key: 'note', label: 'Notes' }
            ] : [
                { key: 'PO_NO', label: 'PO Number' },
                { key: 'COMP_CODE', label: 'Company Code' },
                { key: 'RR_DATE', label: 'Receipt Date' },
                { key: 'VENDOR', label: 'Vendor' },
                { key: 'SKU', label: 'SKU' },
                { key: 'QTYGR', label: 'GR Quantity' },
                { key: 'SLOC', label: 'Storage Loc' },
                { key: 'VFDAT', label: 'Expiry Date' },
                { key: 'jo_status', label: 'Status' },
                { key: 'note', label: 'Notes' }
            ];
            let excelData = [
                columns.map(function(col) { return col.label; })
            ];
            displayedData.forEach(function(row) {
                let rowData = columns.map(function(col) {
                    let value = row[col.key];
                    if (col.key.includes('DATE') || col.key.includes('created_at') || col.key.includes('updated_at')) {
                        return formatDate(value);
                    }
                    return value || '';
                });
                excelData.push(rowData);
            });
            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.aoa_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, currentTab === 'dn' ? 'DeliveryNotes' : 'GoodsReceipts');
            XLSX.writeFile(wb, 'Coldspace_' + (currentTab === 'dn' ? 'DN' : 'GR') + '_Data.xlsx');
        };
    </script>
</body>
</html>

